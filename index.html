<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Player</title>
    <link href="./style.css" rel="stylesheet">
  </head>
  <body>
    <div class="player">
      <div class="player-header">
        <div id="titleEl" class="title"></div>
        <ul class="window-operate">
          <li id="minimizeEl" class="minimize"><a>-</a></li>
          <li id="maximizeEl" class="maximize"><a>+</a></li>
          <li id="closeEl" class="close"><a>&times;</a></li>
        </ul>
      </div>
      <div id="playerContainer"></div>
      <div class="player-control">
        <div class="progress">
          <div class="progress-track"></div>
        </div>
        <div class="control">
          <span class="duration" id="durationEl">00:00:00 / 00:00:00</span>
          <div class="prev"></div>
          <div id="playEl" class="play"></div>
          <div class="next"></div>
          <div class="volume">
            <div id="volumeProgressSlideEl" class="volume-progress-slide"></div>
            <div id="volumeProgressEl" class="volume-progress"></div>
            <input type="range" id="volumeEl" min="0" max="1" step="0.01"/>
          </div>
        </div>
      </div>
    </div>
    <script src="three.js"></script>
    <script>
      const player = require('../node-addons/node-addon-ffmpeg')
      const {
        ipcRenderer
      } = require('electron');

      const progressEl = document.querySelector('.progress-track');
      let playing = false;

      minimizeEl.addEventListener('click', () => {
        ipcRenderer.send('window.minimize');
      });
      maximizeEl.addEventListener('click', () => {
        ipcRenderer.send('window.maximize');
      });
      closeEl.addEventListener('click', () => {
        ipcRenderer.send('window.close');
      });

      playEl.addEventListener('click', () => {
        if (!player.playing) return;
        if (!player.paused) {
          player.pause();
        } else {
          player.resume();
        }
      });
      // 音量控制
      setVolume();
      volumeEl.addEventListener('input', () => {
        setVolume();
      });
      function setVolume() {
        volumeProgressEl.style.width = `${volumeEl.value / volumeEl.max * 100}%`;
        volumeProgressSlideEl.style.left = `calc(${volumeEl.value / volumeEl.max * 100}% - ${volumeEl.value / volumeEl.max * 14}px)`;
        player.volume = volumeEl.value;
      }

      ipcRenderer.on('play', function(event, filename) {
        player.play(filename);
        titleEl.innerText = filename.split('\\').pop();
        ipcRenderer.send('adjust-window', {width: player.video.width, height: player.video.height});
        console.log(player.video)
      });
      player.on('progress', () => {
        durationEl.innerText = `${timestampFormat(player.currentTime)} / ${timestampFormat(player.duration)}`;
        progressEl.style.width = `${player.currentTime / player.duration * 100}%`;
      })


      function timestampFormat(timestamp) {
        const seconds = timestamp / 1000;// 转成秒
        const min = `${Math.floor(seconds % 3600 / 60)}`;
        const hour = `${Math.floor(seconds / 3600)}`;
        const sec = `${Math.floor(seconds % 3600 % 60)}`;
        return `${hour.padStart(2, 0)}:${min.padStart(2, 0)}:${sec.padStart(2, 0)}`;
      }
    </script>
  </body>
</html>