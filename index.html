<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Player</title>
    <style>
    body { margin: 0; }
    canvas { width: 100%; height: 100%; float: left; }
    .player {
      position: fixed;
      width: 100%;
      height: 100%;
      background: #000;
    }
    .player:hover .player-control {
      opacity: 1;
    }
    .player .player-control{
      position: absolute;
      width: 100%;
      height: 70px;
      /* background: #00000085; */
      left: 0;
      bottom: 0;
      opacity: 0;
      z-index: 99999999;
      transition: opacity 0.5s;
    }
    .player .player-control .control {
      text-align: center;
      margin-top: 5px;
    }
    .player .player-control .control>.play {
      height: 40px;
      width: 40px;
      border-radius: 50%;
      background: #fff;
      margin: 8px 10px;
      display: inline-block;
    }
    .player .player-control .control>.prev,
    .player .player-control .control>.next {
      height: 34px;
      width: 34px;
      border-radius: 50%;
      background: #fff;
      margin: 11px 0;
      display: inline-block;
    }
    .player .player-control .progress {
      height: 5px;
      background: #8684848a;
      position: relative;
      width: 96%;
      transform: translateX(2%);
    }
    .player .player-control .progress>.progress-track{
      position: absolute;
      width: 0%;
      height: 100%;
      background: #2196F3;
    }
    
    </style>
  </head>
  <body>
    <div class="player">
      <div id="playerContainer"></div>
      <div class="player-control">
        <div class="progress">
          <div class="progress-track"></div>
        </div>
        <div class="control">
          <div class="prev"></div>
          <div class="play"></div>
          <div class="next"></div>
        </div>
      </div>
    </div>
    <!-- <h1>Hello World!</h1>
    We are using node <script>document.write(process.versions.node)</script>,
    Chrome <script>document.write(process.versions.chrome)</script>,
    and Electron <script>document.write(process.versions.electron)</script>. -->
    <!-- <webview src="./audio.html" nodeintegration enableblinkfeatures="ModuleDedicatedWorker, SharedWorker, ModuleServiceWorker"></webview> -->
    <script>
    </script>
    <script src="three.js"></script>
    <!-- <script src="video.js"></script> -->
    <script src="audio.js"></script>
    <script>
      var progressEl = document.querySelector('.progress-track')

      const ffmpeg = require('../node-addons/node-addon-ffmpeg/build/Release/ffmpeg.node')
      let info, videoInitialized = false
      require('electron').ipcRenderer.on('play', function(event, filename) {
        console.log(filename);  // Prints "whoooooooh!"
        ffmpeg.init(filename)
        info = ffmpeg.getInfo()
        if (!videoInitialized) {
          videoInitialized = true
          if (info.video) {
            var scene = new THREE.Scene();
            var camera = new THREE.PerspectiveCamera( 45, window.innerWidth/window.innerHeight, 0.1, 1000 );
            
            var renderer = new THREE.WebGLRenderer();
            renderer.setSize( window.innerWidth, window.innerHeight );
            document.querySelector('#playerContainer').appendChild( renderer.domElement );
            window.addEventListener( 'resize', onWindowResize, false );
            
            function onWindowResize(){
            
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
            
                renderer.setSize( window.innerWidth, window.innerHeight );
            
            }
                    
            var width = +info.video.width, height = +info.video.height, interval = Math.ceil(1000 / +info.video.fps);
            var ratio = width / height
            // var data = ffmpeg.decodeVideo()
            var data = new Uint8Array(width * height * 3)
            
            var texture = new THREE.DataTexture( data, width, height, THREE.RGBFormat );
            
            var geometry = new THREE.PlaneGeometry( 27 * ratio, 27, 1, 1 )
            // var geometry = new THREE.PlaneGeometry( 48, 27, 1, 1 )
            // var material = new THREE.MeshBasicMaterial( { color: 0xffffff } );
            var material = new THREE.MeshBasicMaterial( { map: texture, side: THREE.DoubleSide, color: 0xffffff } );
            var cube = new THREE.Mesh( geometry, material );
            scene.add( cube );
            cube.rotation.z = Math.PI / 1;
            cube.rotation.y = -Math.PI / 1;
            camera.position.z = 32.7;
            
            renderer.render( scene, camera );
          }
        }
        ffmpeg.readPacket(function(){});
        ffmpeg.update(() => {
          console.log('update audio')
          playAudio()
        }, videoData => {
          // console.log('videoData', videoData)
          if (videoData) {
            texture.image.data = new Uint8Array(videoData);
            texture.needsUpdate = true;
          }
          renderer.render( scene, camera );
        });
      });
    </script>
  </body>
</html>